<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  
  <title>Yale Endowment Configurator</title>
  <meta name="description" content="Build and configure infoboxes for the Yale Endowment visualization">
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic,700italic|Raleway:800,300,100,600" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="main.css">
  <style>
    /* Configurator-specific styles */
    .configurator-container {
      display: block;
      height: 100vh;
      font-family: 'Source Sans Pro', sans-serif;
      background: #f8f9fa;
      overflow-y: auto;
    }

    .sidebar {
      width: 100%;
      background: white;
      border-right: none;
      padding: 0;
      overflow-y: auto;
      height: 100vh;
      box-shadow: none;
    }

    .sidebar-content {
      padding: 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #ba0c2f 0%, #cf2e2e 100%);
      color: white;
      padding: 20px;
      text-align: center;
      margin-bottom: 0;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .main-content {
      display: none;
    }

    .toolbar {
      background: white;
      border-bottom: 2px solid #e9ecef;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .preview-area {
      flex: 1;
      background: #f8f9fa;
      padding: 30px;
      overflow: auto;
      position: relative;
      overflow-x: auto;
      overflow-y: hidden;
      min-width: 600px;
      scroll-behavior: smooth;
      height: calc(100vh - 200px);
      max-height: calc(100vh - 200px);
    }

    /* Custom scrollbar for preview area */
    .preview-area::-webkit-scrollbar {
      height: 20px;
    }

    .preview-area::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
      position: relative;
    }

    .preview-area::-webkit-scrollbar-thumb {
      background: #ba0c2f;
      border-radius: 10px;
    }

    .preview-area::-webkit-scrollbar-thumb:hover {
      background: #a00a28;
    }

    /* Timeline markers on scrollbar */
    .preview-area {
      position: relative;
    }

    .timeline-bar {
      position: relative;
      width: 100%;
      height: 20px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin: 10px 0;
      z-index: 1000;
    }

    .timeline-marker {
      position: absolute;
      top: 2px;
      width: 4px;
      height: 16px;
      background: #ff6900;
      border-radius: 2px;
      pointer-events: auto;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 1001;
    }

    .timeline-marker:hover {
      background: #e55a00;
      transform: scaleY(1.2);
    }

    .config-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .config-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .config-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 16px;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .sidebar-content {
        padding: 20px;
      }
      
      .config-section {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .export-section {
        padding: 20px;
      }
      
      .tab-navigation {
        max-width: 100%;
      }
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .form-control:focus {
      outline: none;
      border-color: #ba0c2f;
      box-shadow: 0 0 0 3px rgba(186, 12, 47, 0.1);
      background: white;
    }

    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }
    
    #infobox-title {
      min-height: 60px !important;
      font-family: inherit;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn-primary {
      background: #ba0c2f;
      color: white;
    }

    .btn-primary:hover {
      background: #a00a28;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      flex: 1;
      min-width: 120px;
    }

    /* Color picker styling */
    input[type="color"] {
      -webkit-appearance: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="color"]:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Improved textarea styling */
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
      font-family: 'Source Sans Pro', sans-serif;
      line-height: 1.5;
    }

    /* Help button styling */
    #help-button {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      border: none;
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #help-button:hover {
      background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
      transform: translateY(-1px);
    }

    .infobox-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    .infobox-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }

    .infobox-item:hover {
      background: #f8f9fa;
    }

    .infobox-item.selected {
      background: #e3f2fd;
      border-left: 3px solid #2196f3;
    }

    .infobox-item .title {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .infobox-item .type {
      font-size: 12px;
      color: #666;
    }

    .preview-container {
      min-height: 600px;
      width: 100%;
      max-width: 1200px;
      background: white;
      position: relative;
      padding: 30px;
      overflow: visible;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border: 2px solid #e9ecef;
    }

    .overview-preview {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      height: 200px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .overview-preview:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .overview-preview.minimized {
      width: 60px;
      height: 60px;
      border-radius: 50%;
    }

    .overview-preview.minimized .overview-content {
      display: none;
    }

    .overview-header {
      background: #ba0c2f;
      color: white;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .overview-header .minimize-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .overview-content {
      padding: 10px;
      height: calc(100% - 40px);
      overflow: hidden;
    }

    .overview-timeline {
      width: 100%;
      height: 20px;
      background: #ba0c2f;
      position: relative;
      margin-bottom: 10px;
      border-radius: 2px;
    }

    .overview-infobox {
      position: absolute;
      width: 4px;
      height: 12px;
      background: #ff6900;
      border-radius: 2px;
      top: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .overview-infobox:hover {
      background: #e55a00;
      transform: scale(1.2);
    }

    .overview-infobox.selected {
      background: #286dc0;
      box-shadow: 0 0 0 2px rgba(40, 109, 192, 0.3);
    }

    .overview-stats {
      font-size: 11px;
      color: #666;
      line-height: 1.3;
    }

    .overview-stats .stat {
      margin-bottom: 4px;
    }

    .yale-ruler-preview {
      width: 101750px;
      height: 400px;
      background: #ba0c2f;
      position: relative;
      margin-bottom: 20px;
      border-radius: 4px;
      margin-left: 0;
    }

    .infobox-preview {
      position: absolute;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      max-width: 300px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s ease;
      pointer-events: auto;
      z-index: 10;
    }
    
    .infobox-preview:hover {
      border-color: #ba0c2f;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .infobox-preview.selected {
      border-color: #ba0c2f;
      box-shadow: 0 0 0 2px rgba(186, 12, 47, 0.3);
    }

    .infobox-preview .title {
      font-weight: 600;
      margin-bottom: 8px;
    }

    .infobox-preview .content {
      font-size: 14px;
      line-height: 1.4;
    }

    .export-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      margin-top: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .export-section textarea {
      width: 100%;
      min-height: 100px;
      font-family: monospace;
      font-size: 12px;
    }

    .status-bar {
      background: white;
      padding: 15px 20px;
      border-top: 2px solid #e9ecef;
      font-size: 14px;
      color: #666;
      font-weight: 500;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0 0 12px 12px;
    }



    .tab-navigation {
      display: flex;
      gap: 2px;
      margin: 20px 0;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 4px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tab-btn:hover {
      background: rgba(186, 12, 47, 0.1);
      color: #ba0c2f;
    }

    .tab-btn.active {
      background: #ba0c2f;
      color: white;
      box-shadow: 0 2px 8px rgba(186, 12, 47, 0.3);
    }

    .tab-content {
      display: none !important;
    }

    .tab-content.active {
      display: block !important;
    }

    .drag-handle {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      background: #ddd;
      border-radius: 50%;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 30px;
      width: 20px;
      height: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }


  </style>
</head>
<body>
  <div class="configurator-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Yale Endowment Configurator</h2>
      </div>
      <div class="sidebar-content">
      
      <!-- Tab Navigation -->
      <div class="tab-navigation" style="margin-bottom: 20px;">
        <button class="tab-btn active" data-tab="wealth-bar">Wealth Bar</button>
        <button class="tab-btn" data-tab="page-style">Page Style</button>
        <button class="tab-btn" data-tab="infobox">Infobox</button>
      </div>
      
      <!-- Wealth Bar Tab -->
      <div id="wealth-bar-tab" class="tab-content active">
        <div class="config-section" style="background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #d4edda;">
          <h4 style="margin: 0 0 10px 0; color: #155724;">Yale Wealth Bar Settings</h4>
          <div class="form-group">
            <label for="yale-endowment-value">Yale Endowment Value (billions)</label>
            <input type="number" id="yale-endowment-value" class="form-control" value="40.7" min="1" max="1000" step="0.1">
          </div>
          <div class="form-group">
            <label for="scale-factor">Scale Factor (pixels per $1,000)</label>
            <input type="number" id="scale-factor" class="form-control" value="1" min="0.1" max="10" step="0.1">
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Current width: <span id="current-width">40,700</span> pixels | 
            Scale: 1 pixel = $<span id="current-scale">1,000</span>
          </div>
        </div>
      </div>
      
      <!-- Page Style Tab -->
      <div id="page-style-tab" class="tab-content">
        <div class="config-section" style="background: #f0f8ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #cce5ff;">
          <h4 style="margin: 0 0 10px 0; color: #004085;">Page Style Settings</h4>
          
          <div class="form-row">
            <div class="form-group">
              <label for="wealth-bar-color">Wealth Bar Color</label>
              <input type="color" id="wealth-bar-color" class="form-control" value="#286dc0" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
            
            <div class="form-group">
              <label for="link-color">Link Color</label>
              <input type="color" id="link-color" class="form-control" value="#ff6900" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="background-color">Page Background Color</label>
              <input type="color" id="background-color" class="form-control" value="#ffffff" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
            
            <div class="form-group">
              <label for="text-color">Main Text Color</label>
              <input type="color" id="text-color" class="form-control" value="#333333" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="title-color">Title Color</label>
              <input type="color" id="title-color" class="form-control" value="#cf2e2e" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
            
            <div class="form-group">
              <label for="infobox-bg-color">Infobox Background Color</label>
              <input type="color" id="infobox-bg-color" class="form-control" value="transparent" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="infobox-text-color">Infobox Text Color</label>
              <input type="color" id="infobox-text-color" class="form-control" value="#ffffff" style="width: 60px; height: 35px; cursor: pointer;">
            </div>
            
            <div class="form-group">
              <label for="font-family">Font Family</label>
              <select id="font-family" class="form-control">
                <option value="Arial, sans-serif">Arial</option>
                <option value="Helvetica, sans-serif">Helvetica</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Times New Roman, serif">Times New Roman</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Roboto', sans-serif">Roboto</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="font-size">Base Font Size (px)</label>
            <input type="number" id="font-size" class="form-control" value="16" min="12" max="24" step="1">
          </div>
        </div>
      </div>
      
      <!-- Infobox Tab -->
      <div id="infobox-tab" class="tab-content">
      
      <!-- Toolbar -->
      <div class="config-section">
        <h3>Quick Actions</h3>
        <div class="btn-group" style="margin-bottom: 15px;">
          <button class="btn btn-secondary" id="preview-mode">Preview Mode</button>
          <button class="btn btn-secondary" id="edit-mode">Edit Mode</button>
          <button class="btn btn-secondary" id="clear-all">Clear All</button>
        </div>
        <div style="font-size: 12px; color: #666;">
          <span id="infobox-count">0</span> infoboxes created
        </div>
      </div>
      
      <!-- Help Button -->
      <div style="margin-bottom: 20px;">
        <button class="btn btn-info" id="help-button" style="width: 100%;">
          <span style="margin-right: 8px;">?</span>How to Use
        </button>
      </div>
      
      <!-- Infobox Configuration -->
      <div class="config-section">
        <h3>Infobox Configuration</h3>
        
        <div class="form-group">
          <label for="infobox-title">Title (supports HTML)</label>
          <textarea id="infobox-title" class="form-control" placeholder="Enter infobox title (supports HTML formatting)" style="min-height: 60px; resize: vertical;"></textarea>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Examples: <code>&lt;strong&gt;Bold text&lt;/strong&gt;</code>, <code>&lt;em&gt;Italic&lt;/em&gt;</code>, <code>&lt;a href="#"&gt;Link&lt;/a&gt;</code>
          </div>
        </div>
        
        <div class="form-group">
          <label for="infobox-content">Content (Optional)</label>
          <textarea id="infobox-content" class="form-control" placeholder="Enter infobox content (supports HTML) - leave empty for title-only infoboxes"></textarea>
        </div>
        
        <div class="form-group">
          <label for="infobox-type">Type</label>
          <select id="infobox-type" class="form-control">
            <option value="text">Text Only</option>
            <option value="block">Text with Visual Block</option>
            <option value="media">Text with Media</option>
          </select>
        </div>
        
        <!-- Visual Block Configuration -->
        <div id="visual-block-config" class="config-section" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #495057;">Visual Block Settings</h4>
          
          <!-- Dollar Amount Input -->
          <div class="form-group">
            <label for="block-dollar-value">Dollar Amount</label>
            <input type="number" id="block-dollar-value" class="form-control" placeholder="Enter dollar amount (e.g., 1000000)" min="0" step="1000" style="border: 2px solid #007bff; font-size: 16px;">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Enter a dollar amount to automatically calculate block dimensions
            </div>
          </div>
          
          <!-- Block Color -->
          <div class="form-group">
            <label for="block-color">Block Color</label>
            <input type="color" id="block-color" class="form-control" value="#ff6900" style="width: 60px; height: 35px; cursor: pointer;">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Background color of the visual block
            </div>
          </div>
          
          <!-- Block Label -->
          <div class="form-group">
            <label for="block-label">Block Label</label>
            <input type="text" id="block-label" class="form-control" placeholder="Enter block label">
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Text label that appears next to the block
            </div>
          </div>
          
          <!-- Show Value Toggle -->
          <div class="form-group">
            <label for="show-value-toggle">Show Dollar Value on Block</label>
            <div style="display: flex; align-items: center; margin-top: 5px;">
              <input type="checkbox" id="show-value-toggle" class="form-control" style="width: auto; margin-right: 10px;" checked>
              <span style="font-size: 12px; color: #666;">Display the dollar amount as text on the block</span>
            </div>
          </div>
          
          <!-- Calculated Dimensions Display -->
          <div class="form-group" style="background: #e9ecef; padding: 10px; border-radius: 4px; margin-top: 15px;">
            <h5 style="margin: 0 0 10px 0; color: #495057;">Calculated Dimensions</h5>
            <div style="font-size: 14px; color: #495057;">
              <div><strong>Width:</strong> <span id="calculated-width">0</span>px</div>
              <div><strong>Height:</strong> <span id="calculated-height">0</span>px</div>
              <div><strong>Scale:</strong> <span id="calculated-scale">0</span>% of Yale endowment</div>
            </div>
          </div>
          
          <!-- Live Preview -->
          <div class="form-group" style="margin-top: 15px;">
            <h5 style="margin: 0 0 10px 0; color: #495057;">Live Preview</h5>
            <div id="block-preview" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; min-height: 100px; display: flex; align-items: center; justify-content: center;">
              <div id="preview-block" style="background: #ff6900; width: 0px; height: 0px; border-radius: 0px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; transition: all 0.3s ease;">
                
              </div>
            </div>
          </div>
        </div>
        
        <!-- Media Configuration -->
        <div id="media-config" class="config-section" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #495057;">Media Settings</h4>
          <div class="form-group">
            <label for="media-type">Media Type</label>
            <select id="media-type" class="form-control">
              <option value="image">Image</option>
              <option value="video">Video</option>
              <option value="iframe">Embedded Content</option>
            </select>
          </div>
          <div class="form-group">
            <label for="media-url">Media URL</label>
            <input type="url" id="media-url" class="form-control" placeholder="Enter media URL or upload file">
          </div>
          <div class="form-group">
            <label for="media-file">Upload File</label>
            <input type="file" id="media-file" class="form-control" accept="image/*,video/*">
          </div>
          <div class="form-group">
            <label for="media-width">Media Width (px)</label>
            <input type="number" id="media-width" class="form-control" value="200" min="50" max="500">
          </div>
          <div class="form-group">
            <label for="media-height">Media Height (px)</label>
            <input type="number" id="media-height" class="form-control" value="150" min="50" max="400">
          </div>
        </div>
        
        <div class="form-group">
          <label for="timeline-position">Timeline Position (0-100%)</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="range" id="timeline-position" class="form-control" min="0" max="100" value="10" style="flex: 1;">
            <span id="timeline-value" style="min-width: 40px; text-align: right; font-weight: 600;">10%</span>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Position along the Yale endowment timeline (0% = start, 100% = end)
          </div>
        </div>
        

        
        <div class="btn-group">
          <button class="btn btn-primary" id="add-infobox">Add Infobox</button>
          <button class="btn btn-secondary" id="update-infobox" style="display: none;">Update</button>
        </div>
      </div>
      
      <!-- Infobox Management -->
      <div class="config-section">
        <h3>Manage Infoboxes</h3>
        <div class="infobox-list" id="infobox-list">
          <!-- Infoboxes will be listed here -->
        </div>
        <div style="margin-top: 10px;">
          <button class="btn btn-danger" id="delete-selected">Delete Selected</button>
        </div>
      </div>
      

      
      <!-- Export Section -->
      <div class="export-section">
        <h3>Export Configuration</h3>
        <div class="btn-group" style="margin-bottom: 15px;">
          <button class="btn btn-success" id="export-config">Export Config</button>
          <button class="btn btn-info" id="import-config">Import Config</button>
          <input type="file" id="config-file-input" accept=".json" style="display: none;">
        </div>
        
        <div class="btn-group" style="margin-bottom: 15px;">
          <button class="btn btn-info" id="test-config">Test in Main Page</button>
          <button class="btn btn-danger" id="generate-all-files">Download All Files</button>
          <button class="btn btn-warning" id="fix-positions">Fix Positions</button>
        </div>
        
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          Downloads one file containing active-config.json, dynamic-css.css, and yale-section.html
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          Downloads one file containing active-config.json, dynamic-css.css, and yale-section.html
        </div>
        <textarea id="export-output" placeholder="Exported code will appear here..." readonly></textarea>
      </div>
      
      <!-- Status Bar -->
      <div class="status-bar">
        <span id="status-message">Start by creating your first infobox using the form above</span>
      </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="toolbar">
        <button class="btn btn-secondary" id="preview-mode">Preview Mode</button>
        <button class="btn btn-secondary" id="edit-mode">Edit Mode</button>
        <button class="btn btn-secondary" id="clear-all">Clear All</button>
        <span style="margin-left: auto; font-size: 14px; color: #666; font-weight: 500;">
          <span id="infobox-count">0</span> infoboxes created
        </span>
      </div>
      
      <div class="preview-area">
        <div class="preview-container" id="preview-container">
          <div class="yale-ruler-preview">
            <div style="position: absolute; top: 10px; left: 10px; color: white; font-weight: 600;">
              Yale Endowment: $40.7 billion
            </div>
            <div style="position: absolute; top: 10px; right: 10px; color: white; font-size: 12px;">
              Scale: 1 pixel = $1,000
            </div>
          </div>
          <!-- Infoboxes will be placed here -->
        </div>
        
      </div>
      
      <!-- Timeline bar with markers -->
      <div class="timeline-bar" id="timeline-bar">
        <!-- Markers will be added here -->
      </div>
      
      <div class="status-bar">
        <span id="status-message">Start by creating your first infobox using the form above</span>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #1976d2;">How to Use the Configurator</h3>
        <button id="close-help" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
      </div>
      <div style="font-size: 14px; line-height: 1.6; color: #333;">
        <p><strong>1.</strong> Use the form below to create new infoboxes (title required, content optional)</p>
        <p><strong>2.</strong> Both title and content support HTML formatting</p>
        <p><strong>3.</strong> Drag infoboxes in the preview area to position them</p>
        <p><strong>4.</strong> Click on any infobox in the preview to edit it</p>
        <p><strong>5.</strong> Click "Test in Main Page" to see your changes immediately</p>
        <p><strong>6.</strong> Click "Save Configuration" to download the JSON file for permanent use</p>
        <p><strong>7.</strong> Click "Generate All Files" to create all necessary files for updating the main page</p>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
        <p><strong>Yale Wealth Bar:</strong> Configure the endowment value and scale factor at the top to adjust the timeline width and visual block calculations.</p>
        <p><strong>Visual Blocks:</strong> Use the dollar value field to automatically calculate block width based on the Yale wealth bar scale.</p>
        <p><strong>Media:</strong> Upload images/videos or link to external content for rich infoboxes.</p>
      </div>
    </div>
  </div>

  <script>
    class InfoboxConfigurator {
      constructor() {
        this.infoboxes = [];
        this.selectedInfobox = null;
        this.isEditMode = false;
        this.isDragging = false;
        this.dragTarget = null;
        
        this.initializeEventListeners();
        this.updateInfoboxCount();
        this.updateYaleWealthBar(); // Initialize Yale wealth bar
        
        // Initialize timeline wealth value
        const initialPercentage = document.getElementById('timeline-position').value;
        this.updateTimelineWealthValue(initialPercentage);
        
        // Try to load existing configuration and fix positions
        this.loadAndFixExistingConfig();
        
        this.showStatus('Start by creating your first infobox using the form above');
        
        // Initialize type config based on current selector value
        const currentType = document.getElementById('infobox-type').value;
        this.showTypeConfig(currentType);
      }
      
      showTypeConfig(type) {
        // Hide all config sections
        const visualBlockConfig = document.getElementById('visual-block-config');
        const mediaConfig = document.getElementById('media-config');
        
        if (visualBlockConfig) {
          visualBlockConfig.style.setProperty('display', 'none', 'important');
        }
        if (mediaConfig) {
          mediaConfig.style.setProperty('display', 'none', 'important');
        }
        
        // Show relevant config section based on type
        if (type === 'block' && visualBlockConfig) {
          visualBlockConfig.style.setProperty('display', 'block', 'important');
        } else if (type === 'media' && mediaConfig) {
          mediaConfig.style.setProperty('display', 'block', 'important');
        }
        // For 'text' type, no additional config is shown
        
        // Update status to show current type
        this.showStatus(`Type set to: ${type}`);
      }
      
      handleMediaFileUpload(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('media-url').value = e.target.result;
          this.showStatus(`Media file "${file.name}" loaded successfully`);
        };
        reader.readAsDataURL(file);
      }
      
      updateYaleWealthBar() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const scaleFactor = parseFloat(document.getElementById('scale-factor').value);
        
        // Use the same scale as the main page
        const baseWidth = 101750; // Same as CSS --yale-width
        const baseEndowment = 40.7; // Base endowment value
        const widthInPixels = (endowmentValue / baseEndowment) * baseWidth;
        
        // Update display
        document.getElementById('current-width').textContent = Math.round(widthInPixels).toLocaleString();
        document.getElementById('current-scale').textContent = Math.round((endowmentValue * 1000000000) / widthInPixels).toLocaleString();
        
        // Update preview ruler
        const rulerPreview = document.querySelector('.yale-ruler-preview');
        if (rulerPreview) {
          rulerPreview.style.width = `${widthInPixels}px`;
          rulerPreview.querySelector('div:first-child').textContent = `Yale Endowment: $${endowmentValue} billion`;
          rulerPreview.querySelector('div:last-child').textContent = `Scale: 1 pixel = $${Math.round((endowmentValue * 1000000000) / widthInPixels).toLocaleString()}`;
        }
        
        this.showStatus(`Updated Yale wealth bar: ${endowmentValue} billion (${Math.round(widthInPixels).toLocaleString()}px)`);
      }
      
      getYaleWealthBarConfig() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value) || 40.7;
        const scaleFactor = parseFloat(document.getElementById('scale-factor').value) || 1;
        
        // Use the same scale as the main page: 101750px for $40.7 billion
        // This gives us the correct scale: 101750px / 40.7 billion = 2500px per billion
        const baseWidth = 101750; // Same as CSS --yale-width
        const baseEndowment = 40.7; // Base endowment value
        const widthInPixels = (endowmentValue / baseEndowment) * baseWidth;
        
        return {
          endowmentValue: endowmentValue,
          scaleFactor: scaleFactor,
          widthInPixels: widthInPixels,
          pixelsPerDollar: widthInPixels / (endowmentValue * 1000000000)
        };
      }
      
      updateTimelineWealthValue(percentage) {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const timelinePercentage = parseFloat(percentage) / 100;
        
        // Calculate the wealth value at this timeline position
        // Assuming linear distribution across the timeline
        const wealthAtPosition = endowmentValue * timelinePercentage;
        
        // Format the wealth value for display
        let wealthDisplay;
        if (wealthAtPosition >= 1) {
          wealthDisplay = `$${wealthAtPosition.toFixed(1)} billion`;
        } else {
          wealthDisplay = `$${(wealthAtPosition * 1000).toFixed(0)} million`;
        }
        
        // Update the timeline value display to show both percentage and wealth
        document.getElementById('timeline-value').textContent = `${percentage}% (${wealthDisplay})`;
      }
      
      formatMoney(amount) {
        // Format money similar to main.js
        if (amount >= 1000000000) {
          return `$${(amount / 1000000000).toFixed(1)}B`;
        } else if (amount >= 1000000) {
          return `$${(amount / 1000000).toFixed(1)}M`;
        } else if (amount >= 1000) {
          return `$${(amount / 1000).toFixed(0)}K`;
        } else {
          return `$${amount.toFixed(0)}`;
        }
      }
      
      updateVisualBlockFromDollarValue() {
        const dollarValue = parseFloat(document.getElementById('block-dollar-value').value) || 0;
        const yaleEndowment = parseFloat(document.getElementById('yale-endowment-value').value) || 40.7;
        const scaleFactor = parseFloat(document.getElementById('scale-factor').value) || 1;
        
        if (dollarValue > 0) {
          // Get Yale wealth bar configuration
          const yaleConfig = this.getYaleWealthBarConfig();
          const timelineWidth = yaleConfig.widthInPixels;
          
          // Calculate the scale: how much of the Yale endowment this represents
          const yaleEndowmentBillions = yaleEndowment * scaleFactor;
          const scalePercentage = (dollarValue / (yaleEndowmentBillions * 1000000000)) * 100;
          
          // Calculate block dimensions
          // Width: proportional to the timeline width
          const calculatedWidth = Math.max(10, Math.min(timelineWidth * 0.8, (scalePercentage / 100) * timelineWidth));
          
          // Height: proportional to width for visual balance
          const calculatedHeight = Math.max(20, Math.min(200, calculatedWidth * 0.4));
          
          // Ensure we have valid numbers
          if (isNaN(calculatedWidth) || isNaN(calculatedHeight)) {
            console.warn('Invalid block dimensions calculated:', { calculatedWidth, calculatedHeight, scalePercentage });
            return;
          }
          
          // Update the display
          const calculatedWidthEl = document.getElementById('calculated-width');
          const calculatedHeightEl = document.getElementById('calculated-height');
          const calculatedScaleEl = document.getElementById('calculated-scale');
          
          if (calculatedWidthEl) calculatedWidthEl.textContent = Math.round(calculatedWidth);
          if (calculatedHeightEl) calculatedHeightEl.textContent = Math.round(calculatedHeight);
          if (calculatedScaleEl) calculatedScaleEl.textContent = scalePercentage.toFixed(4);
          
          // Update the preview
          this.updateBlockPreview(dollarValue, calculatedWidth, calculatedHeight);
          
          this.showStatus(`Calculated: ${Math.round(calculatedWidth)}×${Math.round(calculatedHeight)}px for $${dollarValue.toLocaleString()} (${scalePercentage.toFixed(4)}% of Yale endowment)`);
        } else {
          // Reset display
          const calculatedWidthEl = document.getElementById('calculated-width');
          const calculatedHeightEl = document.getElementById('calculated-height');
          const calculatedScaleEl = document.getElementById('calculated-scale');
          
          if (calculatedWidthEl) calculatedWidthEl.textContent = '0';
          if (calculatedHeightEl) calculatedHeightEl.textContent = '0';
          if (calculatedScaleEl) calculatedScaleEl.textContent = '0';
          
          this.updateBlockPreview(0, 0, 0);
        }
      }
      
      updateBlockPreview(dollarValue, width, height) {
        const previewBlock = document.getElementById('preview-block');
        const blockColor = document.getElementById('block-color')?.value || '#ff6900';
        const showValue = document.getElementById('show-value-toggle')?.checked || false;
        
        if (previewBlock) {
          previewBlock.style.width = `${width}px`;
          previewBlock.style.height = `${height}px`;
          previewBlock.style.backgroundColor = blockColor;
          
          // Show or hide the dollar value based on toggle
          if (showValue && dollarValue > 0) {
            previewBlock.textContent = `$${(dollarValue / 1000000).toFixed(1)}M`;
          } else {
            previewBlock.textContent = '';
          }
          
          // Adjust font size based on block size
          const fontSize = Math.max(8, Math.min(16, Math.min(width, height) * 0.3));
          previewBlock.style.fontSize = `${fontSize}px`;
        }
      }
      
      initializeEventListeners() {
        // Form controls with defensive checks
        const addInfoboxBtn = document.getElementById('add-infobox');
        if (addInfoboxBtn) {
          addInfoboxBtn.addEventListener('click', () => {
            this.addInfobox();
          });
        }
        
        const updateInfoboxBtn = document.getElementById('update-infobox');
        if (updateInfoboxBtn) {
          updateInfoboxBtn.addEventListener('click', () => {
            this.updateInfobox();
          });
        }
        
        const deleteSelectedBtn = document.getElementById('delete-selected');
        if (deleteSelectedBtn) {
          deleteSelectedBtn.addEventListener('click', () => {
            this.deleteSelectedInfobox();
          });
        }
        
        // Toolbar buttons with defensive checks
        const previewModeBtn = document.getElementById('preview-mode');
        if (previewModeBtn) {
          previewModeBtn.addEventListener('click', () => {
            this.setPreviewMode();
          });
        }
        
        const editModeBtn = document.getElementById('edit-mode');
        if (editModeBtn) {
          editModeBtn.addEventListener('click', () => {
            this.setEditMode();
          });
        }
        
        const clearAllBtn = document.getElementById('clear-all');
        if (clearAllBtn) {
          clearAllBtn.addEventListener('click', () => {
            this.clearAll();
          });
        }
        
        // Export buttons with defensive checks
        const exportConfigBtn = document.getElementById('export-config');
        if (exportConfigBtn) {
          exportConfigBtn.addEventListener('click', () => {
            this.exportConfig();
          });
        }
        
        const importConfigBtn = document.getElementById('import-config');
        if (importConfigBtn) {
          importConfigBtn.addEventListener('click', () => {
            const configFileInput = document.getElementById('config-file-input');
            if (configFileInput) {
              configFileInput.click();
            }
          });
        }
        
        const configFileInput = document.getElementById('config-file-input');
        if (configFileInput) {
          configFileInput.addEventListener('change', (e) => {
            this.importConfig(e.target.files[0]);
          });
        }
        
        const testConfigBtn = document.getElementById('test-config');
        if (testConfigBtn) {
          testConfigBtn.addEventListener('click', () => {
            this.testConfiguration();
          });
        }
        
        const generateAllFilesBtn = document.getElementById('generate-all-files');
        if (generateAllFilesBtn) {
          generateAllFilesBtn.addEventListener('click', () => {
            this.generateAllFiles();
          });
        }
        
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            console.log('Tab clicked:', e.target.dataset.tab);
            this.switchTab(e.target.dataset.tab);
          });
        });
        
        // Timeline slider with defensive check
        const timelinePosition = document.getElementById('timeline-position');
        if (timelinePosition) {
          timelinePosition.addEventListener('input', (e) => {
            const percentage = e.target.value;
            const timelineValue = document.getElementById('timeline-value');
            if (timelineValue) {
              timelineValue.textContent = `${percentage}%`;
            }
            this.updateTimelineWealthValue(percentage);
          });
        }
        
        // Type selector with defensive check
        const infoboxType = document.getElementById('infobox-type');
        if (infoboxType) {
          infoboxType.addEventListener('change', (e) => {
            this.showTypeConfig(e.target.value);
          });
        }
        
        // Media file upload with defensive check
        const mediaFile = document.getElementById('media-file');
        if (mediaFile) {
          mediaFile.addEventListener('change', (e) => {
            this.handleMediaFileUpload(e.target.files[0]);
          });
        }
        
        // Yale wealth bar configuration with defensive checks
        const yaleEndowmentValue = document.getElementById('yale-endowment-value');
        if (yaleEndowmentValue) {
          yaleEndowmentValue.addEventListener('input', (e) => {
            this.updateYaleWealthBar();
            // Update timeline wealth value when endowment value changes
            const currentPercentage = document.getElementById('timeline-position')?.value || 0;
            this.updateTimelineWealthValue(currentPercentage);
          });
        }
        
        const scaleFactor = document.getElementById('scale-factor');
        if (scaleFactor) {
          scaleFactor.addEventListener('input', (e) => {
            this.updateYaleWealthBar();
          });
        }
        
        // Visual block dollar value with defensive check
        const blockDollarValue = document.getElementById('block-dollar-value');
        if (blockDollarValue) {
          blockDollarValue.addEventListener('input', (e) => {
            this.updateVisualBlockFromDollarValue();
          });
        }
        
        // Block color with defensive check
        const blockColor = document.getElementById('block-color');
        if (blockColor) {
          blockColor.addEventListener('input', (e) => {
            this.updateVisualBlockFromDollarValue();
          });
        }
        
        // Show value toggle with defensive check
        const showValueToggle = document.getElementById('show-value-toggle');
        if (showValueToggle) {
          showValueToggle.addEventListener('change', (e) => {
            this.updateVisualBlockFromDollarValue();
          });
        }
        
        // Help modal with defensive checks
        const helpButton = document.getElementById('help-button');
        if (helpButton) {
          helpButton.addEventListener('click', () => {
            const helpModal = document.getElementById('help-modal');
            if (helpModal) {
              helpModal.style.display = 'block';
            }
          });
        }
        
        const closeHelp = document.getElementById('close-help');
        if (closeHelp) {
          closeHelp.addEventListener('click', () => {
            const helpModal = document.getElementById('help-modal');
            if (helpModal) {
              helpModal.style.display = 'none';
            }
          });
        }
        
        // Close modal when clicking outside with defensive check
        const helpModal = document.getElementById('help-modal');
        if (helpModal) {
          helpModal.addEventListener('click', (e) => {
            if (e.target.id === 'help-modal') {
              helpModal.style.display = 'none';
            }
          });
        }
        
        // Preview area events
        const previewContainer = document.getElementById('preview-container');
        previewContainer.addEventListener('mousedown', (e) => {
          if (this.isEditMode && e.target.classList.contains('infobox-preview')) {
            this.startDrag(e);
          }
        });
        
        // Click to select infobox for editing
        previewContainer.addEventListener('click', (e) => {
          // Don't trigger if we were dragging
          if (this.isDragging) return;
          
          // Don't trigger if clicking on drag handle or delete button
          if (e.target.classList.contains('drag-handle') || e.target.classList.contains('delete-btn')) {
            return;
          }
          
          if (e.target.classList.contains('infobox-preview') || e.target.closest('.infobox-preview')) {
            const infoboxElement = e.target.classList.contains('infobox-preview') ? e.target : e.target.closest('.infobox-preview');
            const infoboxId = parseInt(infoboxElement.id.replace('infobox-', ''));
            const infobox = this.infoboxes.find(inf => inf.id === infoboxId);
            if (infobox) {
              this.selectInfobox(infobox);
            }
          }
        });
        
        document.addEventListener('mousemove', (e) => {
          if (this.isDragging && this.dragTarget) {
            this.handleDrag(e);
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (this.isDragging) {
            this.stopDrag();
          }
        });
      }
      
      addInfobox() {
        const title = document.getElementById('infobox-title').value.trim();
        const content = document.getElementById('infobox-content').value.trim();
        const type = document.getElementById('infobox-type').value;
        const timelinePosition = parseInt(document.getElementById('timeline-position').value) || 10;
        
        if (!title) {
          this.showStatus('Please fill in at least a title', 'error');
          return;
        }
        
        // Calculate position based on timeline percentage using configurable Yale wealth bar
        const yaleConfig = this.getYaleWealthBarConfig();
        const timelineWidth = yaleConfig.widthInPixels;
        const previewPadding = 20; // Padding of preview container
        const x = (timelinePosition / 100) * timelineWidth + previewPadding;
        const y = 160; // 40% above bottom of wealth bar (400px height)
        
        // Get visual block properties using simplified calculation
        const dollarValue = parseFloat(document.getElementById('block-dollar-value').value) || 0;
        const blockColor = document.getElementById('block-color').value;
        const blockLabel = document.getElementById('block-label').value;
        
        // Calculate dimensions based on dollar value
        let calculatedWidth = 0;
        let calculatedHeight = 0;
        
        if (dollarValue > 0) {
          const yaleEndowment = parseFloat(document.getElementById('yale-endowment-value').value) || 40.7;
          const scaleFactor = parseFloat(document.getElementById('scale-factor').value) || 1;
          const yaleEndowmentBillions = yaleEndowment * scaleFactor;
          const scalePercentage = (dollarValue / (yaleEndowmentBillions * 1000000000)) * 100;
          
          // Calculate block dimensions
          calculatedWidth = Math.max(10, Math.min(timelineWidth * 0.8, (scalePercentage / 100) * timelineWidth));
          calculatedHeight = Math.max(20, Math.min(200, calculatedWidth * 0.4));
        }
        
        const visualBlockProps = {
          color: blockColor,
          width: Math.round(calculatedWidth),
          height: Math.round(calculatedHeight),
          padding: 20, // Default padding
          borderRadius: 0, // Default border radius
          showValue: document.getElementById('show-value-toggle')?.checked || false,
          label: blockLabel,
          value: dollarValue
        };
        
        // Get media properties
        const mediaProps = {
          type: document.getElementById('media-type').value,
          url: document.getElementById('media-url').value,
          width: parseInt(document.getElementById('media-width').value),
          height: parseInt(document.getElementById('media-height').value)
        };
        
        const infobox = {
          id: Date.now(),
          title: title,
          content: content,
          type: type,
          timelinePosition: timelinePosition,
          position: { x: x, y: y },
          class: `infobox-${this.infoboxes.length + 1}`,
          visualBlockProps: visualBlockProps,
          mediaProps: mediaProps
        };
        
        this.infoboxes.push(infobox);
        this.renderInfobox(infobox);
        this.updateInfoboxList();
        this.updateInfoboxCount();
        this.updateTimelineScrollbar();
        this.clearForm();
        this.showStatus(`Infobox "${title}" added at ${timelinePosition}% on timeline`);
      }
      
      updateInfobox() {
        if (!this.selectedInfobox) return;
        
        const title = document.getElementById('infobox-title').value.trim();
        const content = document.getElementById('infobox-content').value.trim();
        const type = document.getElementById('infobox-type').value;
        const timelinePosition = parseInt(document.getElementById('timeline-position').value) || 10;
        
        if (!title) {
          this.showStatus('Please fill in at least a title', 'error');
          return;
        }
        
        // Calculate position based on timeline percentage using configurable Yale wealth bar
        const yaleConfig = this.getYaleWealthBarConfig();
        const timelineWidth = yaleConfig.widthInPixels;
        const previewPadding = 20; // Padding of preview container
        const x = (timelinePosition / 100) * timelineWidth + previewPadding;
        const y = 160; // 40% above bottom of wealth bar (400px height)
        
        // Get visual block properties using simplified calculation
        const dollarValue = parseFloat(document.getElementById('block-dollar-value').value) || 0;
        const blockColor = document.getElementById('block-color').value;
        const blockLabel = document.getElementById('block-label').value;
        
        // Calculate dimensions based on dollar value
        let calculatedWidth = 0;
        let calculatedHeight = 0;
        
        if (dollarValue > 0) {
          const yaleEndowment = parseFloat(document.getElementById('yale-endowment-value').value) || 40.7;
          const scaleFactor = parseFloat(document.getElementById('scale-factor').value) || 1;
          const yaleEndowmentBillions = yaleEndowment * scaleFactor;
          const scalePercentage = (dollarValue / (yaleEndowmentBillions * 1000000000)) * 100;
          
          // Calculate block dimensions
          calculatedWidth = Math.max(10, Math.min(timelineWidth * 0.8, (scalePercentage / 100) * timelineWidth));
          calculatedHeight = Math.max(20, Math.min(200, calculatedWidth * 0.4));
        }
        
        const visualBlockProps = {
          color: blockColor,
          width: Math.round(calculatedWidth),
          height: Math.round(calculatedHeight),
          padding: 20, // Default padding
          borderRadius: 0, // Default border radius
          showValue: document.getElementById('show-value-toggle')?.checked || false,
          label: blockLabel,
          value: dollarValue
        };
        
        // Get media properties
        const mediaProps = {
          type: document.getElementById('media-type').value,
          url: document.getElementById('media-url').value,
          width: parseInt(document.getElementById('media-width').value),
          height: parseInt(document.getElementById('media-height').value)
        };
        
        this.selectedInfobox.title = title;
        this.selectedInfobox.content = content;
        this.selectedInfobox.type = type;
        this.selectedInfobox.timelinePosition = timelinePosition;
        this.selectedInfobox.position = { x: x, y: y };
        this.selectedInfobox.visualBlockProps = visualBlockProps;
        this.selectedInfobox.mediaProps = mediaProps;
        
        this.updateInfoboxDisplay(this.selectedInfobox);
        this.updateInfoboxPosition(this.selectedInfobox);
        this.updateInfoboxList();
        this.updateTimelineScrollbar();
        this.clearForm();
        this.showStatus(`Infobox "${title}" updated at ${timelinePosition}% on timeline`);
        this.selectedInfobox = null;
        document.getElementById('update-infobox').style.display = 'none';
        document.getElementById('add-infobox').style.display = 'inline-block';
      }
      
      renderInfobox(infobox) {
        const previewContainer = document.getElementById('preview-container');
        const infoboxElement = document.createElement('div');
        infoboxElement.className = 'infobox-preview';
        infoboxElement.id = `infobox-${infobox.id}`;
        infoboxElement.style.left = `${infobox.position.x}px`;
        infoboxElement.style.top = `${infobox.position.y}px`;
        
        let content = `
          <div class="drag-handle">⋮</div>
          <button class="delete-btn" onclick="configurator.deleteInfobox(${infobox.id})">×</button>
          <div class="title">${infobox.title}</div>
          ${infobox.content ? `<div class="content">${infobox.content}</div>` : ''}
          <div class="click-hint" style="position: absolute; bottom: 5px; right: 5px; font-size: 10px; color: #666; opacity: 0.7;">Click to edit</div>
        `;
        
        infoboxElement.innerHTML = content;
        previewContainer.appendChild(infoboxElement);
        
        // Add visual block above for block type
        if (infobox.type === 'block') {
          const visualBlock = document.createElement('div');
          visualBlock.style.position = 'absolute';
          visualBlock.style.left = `${infobox.position.x}px`;
          
          // Use custom properties if available, otherwise use defaults
          const props = infobox.visualBlockProps || {};
          const padding = props.padding || 20;
          visualBlock.style.top = `${infobox.position.y - props.height - padding}px`;
          
          visualBlock.style.width = `${props.width || 20}px`;
          visualBlock.style.height = `${props.height || 40}px`;
          visualBlock.style.backgroundColor = props.color || '#ff6900';
          visualBlock.style.borderRadius = `${props.borderRadius || 0}px`;
          
          // Add enhanced features if available
          if (props.showValue && props.value) {
            visualBlock.style.display = 'flex';
            visualBlock.style.alignItems = 'center';
            visualBlock.style.justifyContent = 'center';
            visualBlock.style.color = 'white';
            visualBlock.style.fontSize = '10px';
            visualBlock.style.fontWeight = '700';
            visualBlock.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.8)';
            visualBlock.textContent = `$${(props.value / 1000).toFixed(0)}k`;
          }
          
          if (props.label) {
            const label = document.createElement('div');
            label.style.position = 'absolute';
            label.style.top = '-25px';
            label.style.left = '50%';
            label.style.transform = 'translateX(-50%)';
            label.style.fontSize = '11px';
            label.style.fontWeight = '600';
            label.style.color = '#333';
            label.style.background = 'rgba(255, 255, 255, 0.9)';
            label.style.padding = '2px 6px';
            label.style.borderRadius = '3px';
            label.style.whiteSpace = 'nowrap';
            label.style.pointerEvents = 'none';
            label.style.zIndex = '1001';
            label.textContent = props.label;
            visualBlock.appendChild(label);
          }
          
          visualBlock.id = `visual-block-${infobox.id}`;
          previewContainer.appendChild(visualBlock);
        }
        
        // Add media for media type
        if (infobox.type === 'media' && infobox.mediaProps && infobox.mediaProps.url) {
          const mediaContainer = document.createElement('div');
          mediaContainer.style.position = 'absolute';
          mediaContainer.style.left = `${infobox.position.x}px`;
          mediaContainer.style.top = `${infobox.position.y - 80}px`;
          mediaContainer.style.width = `${infobox.mediaProps.width || 200}px`;
          mediaContainer.style.height = `${infobox.mediaProps.height || 150}px`;
          mediaContainer.style.border = '1px solid #ddd';
          mediaContainer.style.borderRadius = '4px';
          mediaContainer.style.overflow = 'hidden';
          mediaContainer.id = `media-${infobox.id}`;
          
          const props = infobox.mediaProps;
          if (props.type === 'image') {
            mediaContainer.innerHTML = `<img src="${props.url}" style="width: 100%; height: 100%; object-fit: cover;">`;
          } else if (props.type === 'video') {
            mediaContainer.innerHTML = `<video src="${props.url}" controls style="width: 100%; height: 100%; object-fit: cover;"></video>`;
          } else if (props.type === 'iframe') {
            mediaContainer.innerHTML = `<iframe src="${props.url}" style="width: 100%; height: 100%; border: none;"></iframe>`;
          }
          
          previewContainer.appendChild(mediaContainer);
        }
      }
      
      updateInfoboxDisplay(infobox) {
        const element = document.getElementById(`infobox-${infobox.id}`);
        if (element) {
          element.querySelector('.title').innerHTML = infobox.title;
          
          // Update or create content div
          let contentDiv = element.querySelector('.content');
          if (infobox.content) {
            if (!contentDiv) {
              contentDiv = document.createElement('div');
              contentDiv.className = 'content';
              element.querySelector('.title').after(contentDiv);
            }
            contentDiv.innerHTML = infobox.content;
          } else if (contentDiv) {
            contentDiv.remove();
          }
        }
      }
      
      updateInfoboxPosition(infobox) {
        const element = document.getElementById(`infobox-${infobox.id}`);
        if (element) {
          element.style.left = `${infobox.position.x}px`;
          element.style.top = `${infobox.position.y}px`;
        }
      }
      
      updateInfoboxList() {
        const list = document.getElementById('infobox-list');
        list.innerHTML = '';
        
        this.infoboxes.forEach(infobox => {
          const item = document.createElement('div');
          item.className = 'infobox-item';
          item.onclick = () => this.selectInfobox(infobox);
          
          item.innerHTML = `
            <div class="title">${infobox.title}</div>
            <div class="type">${infobox.type} • ${infobox.timelinePosition || 10}%</div>
          `;
          
          list.appendChild(item);
        });
      }
      
      selectInfobox(infobox) {
        this.selectedInfobox = infobox;
        
        // Update form
        document.getElementById('infobox-title').value = infobox.title;
        document.getElementById('infobox-content').value = infobox.content;
        document.getElementById('infobox-type').value = infobox.type;
        document.getElementById('timeline-position').value = infobox.timelinePosition || 10;
        this.updateTimelineWealthValue(infobox.timelinePosition || 10);
        
        // Update visual block properties
                  if (infobox.visualBlockProps) {
            document.getElementById('block-color').value = infobox.visualBlockProps.color || '#ff6900';
            document.getElementById('block-dollar-value').value = infobox.visualBlockProps.value || '';
            document.getElementById('block-label').value = infobox.visualBlockProps.label || '';
            document.getElementById('show-value-toggle').checked = infobox.visualBlockProps.showValue || false;
            
            // Update the preview and calculated dimensions
            this.updateVisualBlockFromDollarValue();
          }
        
        // Update media properties
        if (infobox.mediaProps) {
          document.getElementById('media-type').value = infobox.mediaProps.type || 'image';
          document.getElementById('media-url').value = infobox.mediaProps.url || '';
          document.getElementById('media-width').value = infobox.mediaProps.width || 200;
          document.getElementById('media-height').value = infobox.mediaProps.height || 150;
        }
        
        // Show appropriate config section
        this.showTypeConfig(infobox.type);
        
        // Update buttons
        document.getElementById('add-infobox').style.display = 'none';
        document.getElementById('update-infobox').style.display = 'inline-block';
        
        // Highlight in preview
        document.querySelectorAll('.infobox-preview').forEach(el => el.classList.remove('selected'));
        document.getElementById(`infobox-${infobox.id}`).classList.add('selected');
        
        this.showStatus(`Selected infobox: "${infobox.title}" at ${infobox.timelinePosition || 10}%`);
      }
      
      deleteInfobox(id) {
        const index = this.infoboxes.findIndex(infobox => infobox.id === id);
        if (index > -1) {
          this.infoboxes.splice(index, 1);
          const element = document.getElementById(`infobox-${id}`);
          if (element) element.remove();
          
          // Remove visual block if it exists
          const visualBlock = document.getElementById(`visual-block-${id}`);
          if (visualBlock) visualBlock.remove();
          
          // Remove media if it exists
          const media = document.getElementById(`media-${id}`);
          if (media) media.remove();
          
          this.updateInfoboxList();
          this.updateInfoboxCount();
          this.updateTimelineScrollbar();
          this.showStatus('Infobox deleted');
        }
      }
      
      deleteSelectedInfobox() {
        if (this.selectedInfobox) {
          this.deleteInfobox(this.selectedInfobox.id);
          this.selectedInfobox = null;
          this.clearForm();
          document.getElementById('update-infobox').style.display = 'none';
          document.getElementById('add-infobox').style.display = 'inline-block';
        }
      }
      
      clearForm() {
        document.getElementById('infobox-title').value = '';
        document.getElementById('infobox-content').value = '';
        document.getElementById('infobox-type').value = 'text';
        document.getElementById('timeline-position').value = '10';
        this.updateTimelineWealthValue(10);
        
                  // Reset visual block properties
          document.getElementById('block-color').value = '#ff6900';
          document.getElementById('block-dollar-value').value = '';
          document.getElementById('block-label').value = '';
          document.getElementById('show-value-toggle').checked = true;
          
          // Reset calculated dimensions and preview
          const calculatedWidthEl = document.getElementById('calculated-width');
          const calculatedHeightEl = document.getElementById('calculated-height');
          const calculatedScaleEl = document.getElementById('calculated-scale');
          
          if (calculatedWidthEl) calculatedWidthEl.textContent = '0';
          if (calculatedHeightEl) calculatedHeightEl.textContent = '0';
          if (calculatedScaleEl) calculatedScaleEl.textContent = '0';
          
          this.updateBlockPreview(0, 0, 0);
        
        // Reset media properties
        document.getElementById('media-type').value = 'image';
        document.getElementById('media-url').value = '';
        document.getElementById('media-width').value = '200';
        document.getElementById('media-height').value = '150';
        
        // Hide config sections
        this.showTypeConfig('text');
      }
      
      setPreviewMode() {
        this.isEditMode = false;
        document.querySelectorAll('.infobox-preview').forEach(el => {
          el.style.cursor = 'pointer';
          el.querySelector('.drag-handle').style.display = 'none';
          el.querySelector('.delete-btn').style.display = 'none';
        });
        this.showStatus('Preview mode - click infoboxes to edit them');
      }
      
      setEditMode() {
        this.isEditMode = true;
        document.querySelectorAll('.infobox-preview').forEach(el => {
          el.style.cursor = 'move';
          el.querySelector('.drag-handle').style.display = 'flex';
          el.querySelector('.delete-btn').style.display = 'flex';
        });
        this.showStatus('Edit mode - you can drag, delete, and click to edit infoboxes');
      }
      
      startDrag(e) {
        this.isDragging = true;
        this.dragTarget = e.target;
        e.preventDefault();
      }
      
      handleDrag(e) {
        if (!this.dragTarget) return;
        
        // Only allow dragging infobox elements
        if (!this.dragTarget.classList.contains('infobox-preview')) {
          return;
        }
        
        const rect = document.getElementById('preview-container').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        this.dragTarget.style.left = `${Math.max(0, x)}px`;
        this.dragTarget.style.top = `${Math.max(0, y)}px`;
        
        // Update position in data and recalculate timeline position
        const id = parseInt(this.dragTarget.id.replace('infobox-', ''));
        const infobox = this.infoboxes.find(inf => inf.id === id);
        if (infobox) {
          infobox.position = { x: Math.max(0, x), y: Math.max(0, y) };
          
          // Recalculate timeline position based on x position using configurable Yale wealth bar
          const yaleConfig = this.getYaleWealthBarConfig();
          const timelineWidth = yaleConfig.widthInPixels;
          const previewPadding = 20;
          const adjustedX = Math.max(0, x - previewPadding);
          const timelinePosition = Math.round((adjustedX / timelineWidth) * 100);
          infobox.timelinePosition = Math.min(100, Math.max(0, timelinePosition));
        }
      }
      
      stopDrag() {
        this.isDragging = false;
        this.dragTarget = null;
      }
      
      clearAll() {
        if (confirm('Are you sure you want to clear all infoboxes?')) {
          this.infoboxes = [];
          document.getElementById('preview-container').querySelectorAll('.infobox-preview').forEach(el => el.remove());
          document.getElementById('preview-container').querySelectorAll('[id^="visual-block-"]').forEach(el => el.remove());
          document.getElementById('preview-container').querySelectorAll('[id^="media-"]').forEach(el => el.remove());
          this.updateInfoboxList();
          this.updateInfoboxCount();
          this.updateTimelineScrollbar();
          this.clearForm();
          this.showStatus('All infoboxes cleared');
        }
      }
      
      exportConfig() {
        const config = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          yaleWealthBar: {
            endowmentValue: parseFloat(document.getElementById('yale-endowment-value').value),
            scaleFactor: parseFloat(document.getElementById('scale-factor').value),
            wealthBarColor: document.getElementById('wealth-bar-color').value,
            linkColor: document.getElementById('link-color').value
          },
          pageStyle: {
            backgroundColor: document.getElementById('background-color').value,
            textColor: document.getElementById('text-color').value,
            titleColor: document.getElementById('title-color').value,
            infoboxBgColor: document.getElementById('infobox-bg-color').value,
            infoboxTextColor: document.getElementById('infobox-text-color').value,
            fontFamily: document.getElementById('font-family').value,
            fontSize: parseInt(document.getElementById('font-size').value)
          },
          infoboxes: this.infoboxes
        };
        
        const configJson = JSON.stringify(config, null, 2);
        const blob = new Blob([configJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `yale-config-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showStatus('Configuration exported successfully');
      }
      
      importConfig(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const config = JSON.parse(e.target.result);
            
            // Validate config structure
            if (!config.version || !config.infoboxes) {
              throw new Error('Invalid config file format');
            }
            
            // Import Yale wealth bar settings
            if (config.yaleWealthBar) {
              document.getElementById('yale-endowment-value').value = config.yaleWealthBar.endowmentValue || 40.7;
              document.getElementById('scale-factor').value = config.yaleWealthBar.scaleFactor || 1;
              document.getElementById('wealth-bar-color').value = config.yaleWealthBar.wealthBarColor || '#286dc0';
              document.getElementById('link-color').value = config.yaleWealthBar.linkColor || '#ff6900';
              this.updateYaleWealthBar();
            }
            
            // Import page style settings
            if (config.pageStyle) {
              document.getElementById('background-color').value = config.pageStyle.backgroundColor || '#ffffff';
              document.getElementById('text-color').value = config.pageStyle.textColor || '#333333';
              document.getElementById('title-color').value = config.pageStyle.titleColor || '#cf2e2e';
              document.getElementById('infobox-bg-color').value = config.pageStyle.infoboxBgColor || 'transparent';
              document.getElementById('infobox-text-color').value = config.pageStyle.infoboxTextColor || '#ffffff';
              document.getElementById('font-family').value = config.pageStyle.fontFamily || 'Arial, sans-serif';
              document.getElementById('font-size').value = config.pageStyle.fontSize || 16;
            }
            
            // Import infoboxes and recalculate positions
            this.infoboxes = config.infoboxes || [];
            
            // Recalculate positions for existing infoboxes using the correct scale
            this.infoboxes.forEach(infobox => {
              if (infobox.timelinePosition !== undefined) {
                const yaleConfig = this.getYaleWealthBarConfig();
                const timelineWidth = yaleConfig.widthInPixels;
                const previewPadding = 20;
                const x = (infobox.timelinePosition / 100) * timelineWidth + previewPadding;
                const y = 160;
                infobox.position = { x: x, y: y };
              }
            });
            
            this.updateInfoboxList();
            this.updateInfoboxCount();
            this.renderAllInfoboxes();
            this.updateTimelineScrollbar();
            
            this.showStatus(`Configuration imported successfully: ${this.infoboxes.length} infoboxes loaded and positions recalculated`);
          } catch (error) {
            this.showStatus(`Error importing config: ${error.message}`, 'error');
          }
        };
        reader.readAsText(file);
      }
      
      exportHTML() {
        let html = '';
        this.infoboxes.forEach(infobox => {
          html += `\n          <div class="infobox ${infobox.class} infobox-${infobox.type}">\n`;
          html += `            <div class="title">${infobox.title}</div>\n`;
          html += `            <div class="content">${infobox.content}</div>\n`;
          html += `          </div>\n`;
        });
        
        document.getElementById('export-output').value = html;
        this.showStatus('HTML exported to text area');
      }
      
      exportCSS() {
        let css = '';
        this.infoboxes.forEach(infobox => {
          css += `\n.yale .infobox.${infobox.class} {\n`;
          css += `  left: ${infobox.position.x}px;\n`;
          css += `  top: ${infobox.position.y}px;\n`;
          css += `}\n`;
        });
        
        document.getElementById('export-output').value = css;
        this.showStatus('CSS exported to text area');
      }
      
      applyToMainPage() {
        // Get current Yale wealth bar settings
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const scaleFactor = parseFloat(document.getElementById('scale-factor').value);
        
        // Calculate the width based on the same scale as the main page
        const baseWidth = 101750; // Same as CSS --yale-width
        const baseEndowment = 40.7; // Base endowment value
        const calculatedWidth = (endowmentValue / baseEndowment) * baseWidth;
        
        // Save configuration to a file that index.html can load
        const config = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          yaleWealthBar: {
            endowmentValue: endowmentValue,
            scaleFactor: scaleFactor,
            calculatedWidth: calculatedWidth
          },
          infoboxes: this.infoboxes
        };
        
        // Generate CSS with dynamic values
        const cssContent = this.generateDynamicCSS(endowmentValue, calculatedWidth);
        
        // Generate HTML with dynamic values
        const htmlContent = this.generateDynamicHTML(endowmentValue);
        
        // Create a download link for the configuration file
        const configJson = JSON.stringify(config, null, 2);
        const blob = new Blob([configJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'current-config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Also save to localStorage for immediate use
        localStorage.setItem('yaleEndowmentConfig', configJson);
        
        // Show the generated CSS and HTML in the export output
        const exportOutput = document.getElementById('export-output');
        exportOutput.value = `// Generated CSS Variables
${cssContent}

// Generated HTML
${htmlContent}

// Configuration JSON
${configJson}`;
        
        this.showStatus(`Configuration saved! Yale endowment: $${endowmentValue}B, Width: ${Math.round(calculatedWidth).toLocaleString()}px`);
        
        // Show instructions
        setTimeout(() => {
          alert(`Configuration saved successfully!

Generated dynamic CSS and HTML with:
- Yale Endowment: $${endowmentValue} billion
- Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels

The CSS and HTML are shown in the export area below. Copy these to update your main page!`);
        }, 100);
      }
      
      generateDynamicCSS(endowmentValue, calculatedWidth) {
        // Calculate various block sizes based on the new endowment value
        const endowmentInDollars = endowmentValue * 1000000000;
        
        // Calculate block sizes as percentages of the Yale width
        const lifetimeBlock = (1930000 / endowmentInDollars) * 100; // $1.93M lifetime earnings
        const rentBlock = (24000 / endowmentInDollars) * 100; // $24K annual rent
        const childcareBlock = (15000 / endowmentInDollars) * 100; // $15K annual childcare
        const groceriesBlock = (10000 / endowmentInDollars) * 100; // $10K annual groceries
        const transportationBlock = (8000 / endowmentInDollars) * 100; // $8K annual transportation
        const retirementBlock = (6000 / endowmentInDollars) * 100; // $6K annual retirement
        const utilitiesBlock = (5000 / endowmentInDollars) * 100; // $5K annual utilities
        const annualTotalBlock = (72000 / endowmentInDollars) * 100; // $72K total annual expenses
        
        // Get color settings
        const wealthBarColor = document.getElementById('wealth-bar-color').value;
        const linkColor = document.getElementById('link-color').value;
        const backgroundColor = document.getElementById('background-color').value;
        const textColor = document.getElementById('text-color').value;
        const titleColor = document.getElementById('title-color').value;
        const infoboxBgColor = document.getElementById('infobox-bg-color').value;
        const infoboxTextColor = document.getElementById('infobox-text-color').value;
        const fontFamily = document.getElementById('font-family').value;
        const fontSize = document.getElementById('font-size').value;
        
        return `/* Dynamic CSS Variables for Yale Endowment: $${endowmentValue}B */
:root {
  --yale-width: ${Math.round(calculatedWidth)}px;
  --yale-height: 400px;
  --yale-area: calc(var(--yale-width) * var(--yale-height));
  
  /* Color settings */
  --yale-wealth-bar-color: ${wealthBarColor};
  --yale-link-color: ${linkColor};
  --page-background-color: ${backgroundColor};
  --main-text-color: ${textColor};
  --title-color: ${titleColor};
  --infobox-background-color: ${infoboxBgColor};
  --infobox-text-color: ${infoboxTextColor};
  --font-family: ${fontFamily};
  --font-size: ${fontSize}px;
  
  /* Block dimensions relative to Yale width (percentage of Yale's width) */
  --lifetime-block: calc(var(--yale-width) * ${lifetimeBlock.toFixed(6)});
  --rent-block: calc(var(--yale-width) * ${rentBlock.toFixed(6)});
  --childcare-block: calc(var(--yale-width) * ${childcareBlock.toFixed(6)});
  --groceries-block: calc(var(--yale-width) * ${groceriesBlock.toFixed(6)});
  --transportation-block: calc(var(--yale-width) * ${transportationBlock.toFixed(6)});
  --retirement-block: calc(var(--yale-width) * ${retirementBlock.toFixed(6)});
  --utilities-block: calc(var(--yale-width) * ${utilitiesBlock.toFixed(6)});
  --annual-total-block: calc(var(--yale-width) * ${annualTotalBlock.toFixed(6)});
  
  /* Yale-specific blocks */
  --yale-worker-wage-block: calc(var(--yale-width) * 0.00177);
  --yale-schwarzman-block: calc(var(--yale-width) * 0.0147);
  --yale-residential-block: calc(var(--yale-width) * 0.0037);
  --yale-science-block: calc(var(--yale-width) * 0.0049);
  --yale-campaign-block: calc(var(--yale-width) * 0.172);
  --yale-worker-bonus-block: calc(var(--yale-width) * 0.0098);
  --yale-housing-block: calc(var(--yale-width) * 0.0098);
  --yale-childcare-block: calc(var(--yale-width) * 0.0074);
  --yale-minimum-wage-block: calc(var(--yale-width) * 0.049);
  --yale-housing-large-block: calc(var(--yale-width) * 0.0098);
  
  /* Bar dimensions relative to Yale width */
  --worker-bonus-bar: calc(var(--yale-width) * 0.006);
  --worker-housing-bar: calc(var(--yale-width) * 0.006);
  --worker-childcare-bar: calc(var(--yale-width) * 0.0045);
  --worker-wage-bar: calc(var(--yale-width) * 0.03);
  
  /* Growth bar dimensions */
  --growth-bar-width: calc(var(--yale-width) * 0.15);
  --growth-wealth-width: calc(var(--yale-width) * 0.2);
}`;
      }
      
      generateDynamicHTML(endowmentValue) {
        return `<!-- Dynamic HTML for Yale Endowment: $${endowmentValue}B -->
<div class="wealth-wrapper yale">
  <div id="yale" class="wealth ruler">
    <div class="key">
      <span>50m</span>
    </div>
    <h2 class="wealth-title">$${endowmentValue} billion (Yale University endowment)</h2>
    <div class="counter" id="yale-counter"></div>
    
    <!-- Infoboxes will be loaded from configuration file -->
    <div id="infoboxes-container">
      <!-- Infoboxes will be dynamically loaded here -->
    </div>
  </div>
</div>`;
      }
      
      exportDynamicCSS() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const baseWidth = 101750;
        const baseEndowment = 40.7;
        const calculatedWidth = (endowmentValue / baseEndowment) * baseWidth;
        
        const cssContent = this.generateDynamicCSS(endowmentValue, calculatedWidth);
        
        // Create download link
        const blob = new Blob([cssContent], { type: 'text/css' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `yale-dynamic-${endowmentValue}B.css`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show in export area
        document.getElementById('export-output').value = cssContent;
        
        this.showStatus(`Dynamic CSS exported for $${endowmentValue}B endowment`);
      }
      
      generateAllFiles() {
        // Get current Yale wealth bar settings
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const scaleFactor = parseFloat(document.getElementById('scale-factor').value);
        
        // Calculate the width based on the same scale as the main page
        const baseWidth = 101750; // Same as CSS --yale-width
        const baseEndowment = 40.7; // Base endowment value
        const calculatedWidth = (endowmentValue / baseEndowment) * baseWidth;
        
        // Generate all content
        const cssContent = this.generateDynamicCSS(endowmentValue, calculatedWidth);
        const htmlContent = this.generateDynamicHTML(endowmentValue);
        
        // Create configuration
        const config = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          yaleWealthBar: {
            endowmentValue: endowmentValue,
            scaleFactor: scaleFactor,
            calculatedWidth: calculatedWidth
          },
          infoboxes: this.infoboxes
        };
        
        const configJson = JSON.stringify(config, null, 2);
        
        // Trigger all 3 individual file downloads
        this.downloadAllFiles(endowmentValue, calculatedWidth, configJson, cssContent, htmlContent);
        
        // Also create a zip file with all the generated content
        this.createAndDownloadZip({
          'active-config.json': configJson,
          'dynamic-css.css': cssContent,
          'yale-section.html': htmlContent,
          'README.md': this.generateReadme(endowmentValue, calculatedWidth)
        });
        
        // Save to localStorage for immediate testing
        localStorage.setItem('yaleEndowmentConfig', configJson);
        
        // Show summary in export area
        const exportOutput = document.getElementById('export-output');
        exportOutput.value = `# Generated Files for Yale Endowment: $${endowmentValue}B

## Files Created:
1. active-config.json - Configuration with infoboxes
2. dynamic-css.css - CSS variables for new endowment value
3. yale-section.html - HTML section for new endowment value
4. README.md - Instructions for implementation

## Implementation Steps:
1. Replace the CSS variables in main.css with the content from dynamic-css.css
2. Replace the Yale section in index.html with the content from yale-section.html
3. Place active-config.json in the Config Files folder
4. Refresh the page to see your changes

## Configuration Summary:
- Endowment Value: $${endowmentValue} billion
- Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels
- Infoboxes: ${this.infoboxes.length} created
- Scale Factor: ${scaleFactor}x

## Files Content:

### active-config.json:
${configJson}

### dynamic-css.css:
${cssContent}

### yale-section.html:
${htmlContent}`;
        
        this.showStatus(`Generated all files for $${endowmentValue}B endowment! Check the export area below.`);
      }
      
      createIndividualFiles(files) {
        // Create individual download links for each file
        for (const [filename, content] of Object.entries(files)) {
          const blob = new Blob([content], { 
            type: filename.endsWith('.json') ? 'application/json' : 
                  filename.endsWith('.css') ? 'text/css' : 
                  filename.endsWith('.html') ? 'text/html' : 'text/markdown'
          });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      }
      
      createAndDownloadZip(files) {
        // Create a simple zip-like structure using a single file with all content
        let zipContent = '';
        
        for (const [filename, content] of Object.entries(files)) {
          zipContent += `\n\n=== ${filename} ===\n`;
          zipContent += content;
        }
        
        // Create download link
        const blob = new Blob([zipContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `yale-endowment-${endowmentValue}B-files.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      generateReadme(endowmentValue, calculatedWidth) {
        return `# Yale Endowment Files - $${endowmentValue}B

Generated on: ${new Date().toLocaleString()}

## Files Included:
1. active-config.json - Configuration file with infoboxes
2. dynamic-css.css - CSS variables for the new endowment value
3. yale-section.html - HTML section for the new endowment value

## Implementation Instructions:

### 1. Update CSS Variables
Replace the CSS variables in main.css with the content from dynamic-css.css:
- Find the :root section in main.css
- Replace the --yale-width and related variables
- This will scale all visual elements to the new endowment value

### 2. Update HTML Section
Replace the Yale section in index.html with the content from yale-section.html:
- Find the <div class="wealth-wrapper yale"> section
- Replace it with the new HTML content
- This updates the endowment value display

### 3. Update Configuration
Place active-config.json in the Config Files folder:
- This contains all your infoboxes and settings
- The page will automatically load this configuration

### 4. Test Changes
Refresh the page to see all changes applied:
- New endowment value displayed
- All visual elements scaled correctly
- Your infoboxes positioned properly

## Technical Details:
- Endowment Value: $${endowmentValue} billion
- Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels
- Scale Factor: Proportional to original 40.7B baseline

## Notes:
- All block sizes are automatically recalculated
- Infobox positions are maintained relative to the new scale
- The system maintains proper proportions for any endowment value`;
      }
      
      downloadDynamicCSS() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const baseWidth = 101750;
        const baseEndowment = 40.7;
        const calculatedWidth = (endowmentValue / baseEndowment) * baseWidth;
        
        const cssContent = this.generateDynamicCSS(endowmentValue, calculatedWidth);
        
        // Create download link
        const blob = new Blob([cssContent], { type: 'text/css' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `dynamic-css-${endowmentValue}B.css`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show in export area
        document.getElementById('export-output').value = `# Dynamic CSS for Yale Endowment: $${endowmentValue}B

## File: dynamic-css-${endowmentValue}B.css
## Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels

${cssContent}

## Instructions:
1. Save this file as 'dynamic-css.css' in the Config Files folder
2. The main page will automatically load and apply these CSS variables
3. This will scale all visual elements to the new endowment value`;
        
        this.showStatus(`Dynamic CSS downloaded for $${endowmentValue}B endowment`);
      }
      
      downloadAllFiles(endowmentValue, calculatedWidth, configJson, cssContent, htmlContent) {
        // Download files one by one with delays to avoid browser blocking
        this.downloadFile('active-config.json', configJson, 'application/json', 0);
        this.downloadFile('dynamic-css.css', cssContent, 'text/css', 500);
        this.downloadFile('yale-section.html', htmlContent, 'text/html', 1000);
        
        // Show summary in export area
        const exportOutput = document.getElementById('export-output');
        exportOutput.value = `# All Files Downloaded for Yale Endowment: $${endowmentValue}B

## Files Downloaded:
1. active-config.json - Configuration with infoboxes
2. dynamic-css.css - CSS variables for new endowment value  
3. yale-section.html - HTML section for new endowment value

## Implementation Steps:
1. Place all 3 files in the Config Files folder
2. Refresh index.html to see all changes applied
3. The system will automatically load and apply everything

## Configuration Summary:
- Endowment Value: $${endowmentValue} billion
- Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels
- Infoboxes: ${this.infoboxes.length} created

## File Contents:

### active-config.json:
${configJson}

### dynamic-css.css:
${cssContent}

### yale-section.html:
${htmlContent}`;
        
        this.showStatus(`Starting downloads for $${endowmentValue}B endowment...`);
      }
      
      downloadFile(filename, content, mimeType, delay) {
        setTimeout(() => {
          const blob = new Blob([content], { type: mimeType });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          console.log(`Downloaded: ${filename}`);
        }, delay);
      }
      
      switchTab(tabName) {
        console.log('Switching to tab:', tabName);
        
        // Remove active class from all tabs and buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to selected tab and button
        const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
        const tabContent = document.getElementById(`${tabName}-tab`);
        
        if (tabButton) {
          tabButton.classList.add('active');
          console.log('Added active class to button');
        } else {
          console.log('Tab button not found for:', tabName);
        }
        
        if (tabContent) {
          tabContent.classList.add('active');
          console.log('Added active class to content');
        } else {
          console.log('Tab content not found for:', tabName);
        }
      }
      
      loadAndFixExistingConfig() {
        // Try to load from localStorage first
        const localConfig = localStorage.getItem('yaleEndowmentConfig');
        if (localConfig) {
          try {
            const config = JSON.parse(localConfig);
            if (config.infoboxes && config.infoboxes.length > 0) {
              this.infoboxes = config.infoboxes;
              this.fixInfoboxPositions();
              this.showStatus(`Loaded and fixed ${this.infoboxes.length} infoboxes from localStorage`);
              return;
            }
          } catch (error) {
            console.log('Error loading from localStorage:', error);
          }
        }
        
        // If no localStorage, try to load from active-config.json
        fetch('Config Files/active-config.json')
          .then(response => response.json())
          .then(config => {
            if (config.infoboxes && config.infoboxes.length > 0) {
              this.infoboxes = config.infoboxes;
              this.fixInfoboxPositions();
              this.showStatus(`Loaded and fixed ${this.infoboxes.length} infoboxes from active-config.json`);
            }
          })
          .catch(error => {
            console.log('No existing configuration found or error loading:', error);
          });
      }
      
      fixInfoboxPositions() {
        console.log('Fixing infobox positions...');
        
        // Recalculate positions for all existing infoboxes
        this.infoboxes.forEach((infobox, index) => {
          if (infobox.timelinePosition !== undefined) {
            const yaleConfig = this.getYaleWealthBarConfig();
            const timelineWidth = yaleConfig.widthInPixels;
            const previewPadding = 20;
            const x = (infobox.timelinePosition / 100) * timelineWidth + previewPadding;
            const y = 160;
            
            console.log(`Infobox ${index}: timelinePosition=${infobox.timelinePosition}%, oldX=${infobox.position.x}, newX=${x}, timelineWidth=${timelineWidth}`);
            
            infobox.position = { x: x, y: y };
          }
        });
        
        // Update the display
        this.renderAllInfoboxes();
        this.updateInfoboxList();
        this.updateTimelineScrollbar();
        
        this.showStatus(`Fixed positions for ${this.infoboxes.length} infoboxes`);
      }
      
      downloadDynamicCSS() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const baseWidth = 101750;
        const baseEndowment = 40.7;
        const calculatedWidth = (endowmentValue / baseEndowment) * baseWidth;
        
        const cssContent = this.generateDynamicCSS(endowmentValue, calculatedWidth);
        
        // Create download link
        const blob = new Blob([cssContent], { type: 'text/css' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `dynamic-css-${endowmentValue}B.css`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show in export area
        document.getElementById('export-output').value = `# Dynamic CSS for Yale Endowment: $${endowmentValue}B

## File: dynamic-css-${endowmentValue}B.css
## Calculated Width: ${Math.round(calculatedWidth).toLocaleString()} pixels

${cssContent}

## Instructions:
1. Save this file as 'dynamic-css.css' in the Config Files folder
2. The main page will automatically load and apply these CSS variables
3. This will scale all visual elements to the new endowment value`;
        
        this.showStatus(`Dynamic CSS downloaded for $${endowmentValue}B endowment`);
      }
      
      downloadYaleSection() {
        const endowmentValue = parseFloat(document.getElementById('yale-endowment-value').value);
        const htmlContent = this.generateDynamicHTML(endowmentValue);
        
        // Create download link
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `yale-section-${endowmentValue}B.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show in export area
        document.getElementById('export-output').value = `# Yale Section HTML for Yale Endowment: $${endowmentValue}B

## File: yale-section-${endowmentValue}B.html

${htmlContent}

## Instructions:
1. Save this file as 'yale-section.html' in the Config Files folder
2. The main page will automatically load and apply this HTML section
3. This will update the endowment value display in the main page`;
        
        this.showStatus(`Yale section HTML downloaded for $${endowmentValue}B endowment`);
      }
      
      testConfiguration() {
        // Save configuration to localStorage and open index.html in a new tab
        const config = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          yaleWealthBar: {
            endowmentValue: parseFloat(document.getElementById('yale-endowment-value').value),
            scaleFactor: parseFloat(document.getElementById('scale-factor').value)
          },
          infoboxes: this.infoboxes
        };
        
        const configJson = JSON.stringify(config, null, 2);
        localStorage.setItem('yaleEndowmentConfig', configJson);
        
        // Open index.html in a new tab
        const newWindow = window.open('index.html', '_blank');
        
        this.showStatus('Configuration saved to localStorage and opening index.html in new tab for testing');
      }
      
      updateInfoboxCount() {
        document.getElementById('infobox-count').textContent = this.infoboxes.length;
        this.updateTimelineScrollbar();
      }
      
      renderAllInfoboxes() {
        // Clear existing infoboxes from preview
        document.getElementById('preview-container').querySelectorAll('.infobox-preview').forEach(el => el.remove());
        document.getElementById('preview-container').querySelectorAll('[id^="visual-block-"]').forEach(el => el.remove());
        document.getElementById('preview-container').querySelectorAll('[id^="media-"]').forEach(el => el.remove());
        
        // Render all infoboxes
        this.infoboxes.forEach(infobox => {
          this.renderInfobox(infobox);
        });
      }
      
      updateTimelineScrollbar() {
        const timelineBar = document.getElementById('timeline-bar');
        if (!timelineBar) return;
        
        // Remove existing markers
        timelineBar.innerHTML = '';
        
        // Add markers for each infobox
        this.infoboxes.forEach(infobox => {
          const marker = document.createElement('div');
          marker.className = 'timeline-marker';
          
          // Calculate position based on timeline percentage and timeline bar width
          const barWidth = timelineBar.offsetWidth;
          const markerPosition = (infobox.timelinePosition / 100) * barWidth;
          marker.style.left = `${markerPosition}px`;
          marker.title = `${infobox.title} (${infobox.timelinePosition}%)`;
          
          // Add click handler to select infobox and scroll to it
          marker.addEventListener('click', () => {
            this.selectInfobox(infobox);
            this.scrollToInfobox(infobox);
          });
          
          timelineBar.appendChild(marker);
        });
        
        // Debug: log marker creation and positioning
        console.log(`Created ${this.infoboxes.length} timeline markers`);
        console.log('Timeline bar width:', timelineBar.offsetWidth);
      }
      
      scrollToInfobox(infobox) {
        const previewArea = document.querySelector('.preview-area');
        const previewContainer = document.getElementById('preview-container');
        
        // Find the infobox element in the preview
        let infoboxElement = null;
        
        if (infobox.type === 'text') {
          infoboxElement = previewContainer.querySelector(`[data-infobox-id="${infobox.id}"]`);
        } else if (infobox.type === 'block') {
          infoboxElement = previewContainer.querySelector(`#visual-block-${infobox.id}`);
        } else if (infobox.type === 'media') {
          infoboxElement = previewContainer.querySelector(`#media-${infobox.id}`);
        }
        
        if (infoboxElement) {
          // Calculate the scroll position to center the infobox
          const previewRect = previewArea.getBoundingClientRect();
          const infoboxRect = infoboxElement.getBoundingClientRect();
          
          // Calculate the target scroll position
          const targetScrollLeft = previewArea.scrollLeft + (infoboxRect.left - previewRect.left) - (previewRect.width / 2) + (infoboxRect.width / 2);
          
          // Smooth scroll to the infobox
          previewArea.scrollTo({
            left: targetScrollLeft,
            behavior: 'smooth'
          });
          
          // Add a brief highlight effect
          infoboxElement.style.boxShadow = '0 0 10px rgba(25, 118, 210, 0.8)';
          setTimeout(() => {
            infoboxElement.style.boxShadow = '';
          }, 2000);
        }
      }
      
      showStatus(message, type = 'info') {
        const statusElement = document.getElementById('status-message');
        statusElement.textContent = message;
        statusElement.style.color = type === 'error' ? '#dc3545' : '#666';
      }
    }
    
    // Initialize the configurator
    const configurator = new InfoboxConfigurator();
  </script>
</body>
</html>
